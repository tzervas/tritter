name: Progressive CI Quality Gates

# Manual trigger only - run checks locally first
# Cost optimization: use local checks (bash .github/scripts/run-ci.sh)
# CI provides verification before critical merges
on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run CI on (defaults to current)'
        required: false
        type: string
      strictness_override:
        description: 'Override strictness level (0-3, leave empty for auto-detect)'
        required: false
        type: choice
        options:
          - ''
          - '0'
          - '1'
          - '2'
          - '3'

env:
  PYTHON_VERSION: "3.12"
  CI_CONFIG_FILE: ".github/ci-config.yml"

# Minimal permissions - security best practice
permissions:
  contents: read
  pull-requests: write  # For PR comments only
  issues: write  # For issue comments only

jobs:
  progressive-quality-gate:
    name: Quality Gate (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        # Add macos-latest, windows-latest for cross-platform testing if needed

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for branch detection

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install uv (fast package installer)
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv pip install --system -e ".[dev,training,curation]"
          # Install bc for floating point comparison in coverage checks
          sudo apt-get update && sudo apt-get install -y bc

      - name: Detect branch strictness level
        id: strictness
        run: |
          # Use override if provided, otherwise auto-detect
          if [[ -n "${{ github.event.inputs.strictness_override }}" ]]; then
            export STRICTNESS_LEVEL="${{ github.event.inputs.strictness_override }}"
            export BRANCH="${{ github.event.inputs.branch || github.ref_name }}"
            case "$STRICTNESS_LEVEL" in
              0) export STRICTNESS_NAME="FEATURE" ;;
              1) export STRICTNESS_NAME="DEVELOPMENT" ;;
              2) export STRICTNESS_NAME="RELEASE" ;;
              3) export STRICTNESS_NAME="PRODUCTION" ;;
            esac
            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
            echo "level=$STRICTNESS_LEVEL" >> $GITHUB_OUTPUT
            echo "name=$STRICTNESS_NAME" >> $GITHUB_OUTPUT
          else
            eval "$(bash .github/scripts/detect-branch-strictness.sh)"
            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
            echo "level=$STRICTNESS_LEVEL" >> $GITHUB_OUTPUT
            echo "name=$STRICTNESS_NAME" >> $GITHUB_OUTPUT
          fi
          echo "### Progressive CI Configuration (Manual Trigger)" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`$BRANCH\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Strictness Level**: $STRICTNESS_LEVEL ($STRICTNESS_NAME)" >> $GITHUB_STEP_SUMMARY
          echo "- **Note**: CI is manual-only. Run \`bash scripts/run-checks-local.sh\` locally first." >> $GITHUB_STEP_SUMMARY

      - name: Run progressive CI checks
        run: |
          bash .github/scripts/run-ci.sh

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-${{ matrix.os }}
          path: |
            coverage.json
            htmlcov/
            .coverage
          retention-days: 30

      # Note: Security (secrets + bandit) and build checks are handled by
      # custom_checks in ci-config.yml, executed by run-ci.sh above.
      # This ensures 1:1 parity between local and remote CI.
      # Run locally: bash scripts/run-checks-local.sh
