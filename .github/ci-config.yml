# CI Boilerplate Configuration for Tritter
# Progressive CI strictness adapted for multimodal AI model development

project:
  name: "Tritter"
  language: "python"
  description: "Multimodal transformer with BitNet 1.58-bit ternary quantization"

# Branch Classification Patterns
# Aligned with Tritter's development workflow
branch_patterns:
  feature: "feature/*, fix/*, bugfix/*, hotfix/*, claude/*, copilot/*, experimental/*, wip/*"
  development: "dev, develop, development, integration"
  release: "release/*, rc/*, beta/*, staging"
  production: "main, master, stable"

# Progressive Strictness Levels (0-3)
# Adapted for AI/ML research and development workflow
strictness_levels:
  # Level 0: FEATURE - Most lenient (active development, experimentation)
  feature:
    format: warn          # warn | error | skip
    lint: warn
    typecheck: warn       # MyPy strict mode
    tests: warn           # Unit tests
    imports: warn         # Import validation
    coverage_threshold: 50
    todos: allow          # allow | warn | error
    debug_code: allow
    pedantic_lint: skip
    security_audit: basic  # basic | standard | strict | skip
    auto_fix: enabled     # enabled | disabled
    gpu_tests: skip       # GPU tests expensive, skip on feature branches
    slow_tests: skip      # Skip slow integration tests

  # Level 1: DEVELOPMENT - Integration ready
  development:
    format: error
    lint: warn
    typecheck: warn
    tests: warn
    imports: warn
    coverage_threshold: 70
    todos: allow
    debug_code: warn
    pedantic_lint: warn
    security_audit: standard
    auto_fix: enabled
    gpu_tests: warn       # Run but don't fail
    slow_tests: warn

  # Level 2: RELEASE - Pre-production quality
  release:
    format: error
    lint: error
    typecheck: error
    tests: error
    imports: error
    coverage_threshold: 80
    todos: warn
    debug_code: error
    pedantic_lint: warn
    security_audit: strict
    auto_fix: report_only
    gpu_tests: warn       # Run but don't fail (CI may not have GPU)
    slow_tests: error

  # Level 3: PRODUCTION - Zero tolerance
  production:
    format: error
    lint: error
    typecheck: error
    tests: error
    imports: error
    coverage_threshold: 85
    todos: error
    debug_code: error
    pedantic_lint: error
    security_audit: strict
    auto_fix: disabled
    gpu_tests: warn       # Run but document if skipped
    slow_tests: error

# Language-Specific Commands
# Configured for Tritter's Python stack: ruff, mypy, pytest
commands:
  python:
    format: "ruff format --check ."
    format_fix: "ruff format ."
    lint: "ruff check ."
    lint_fix: "ruff check --fix ."
    lint_pedantic: "ruff check --select ALL ."
    typecheck: 'python -c "import torch" && mypy src/tritter || echo "Dependencies not installed, skipping type check"'
    test: 'python -c "import torch" && pytest -v -m "not gpu and not slow" || echo "Dependencies not installed, skipping tests"'
    test_gpu: 'python -c "import torch" && pytest -v -m gpu || echo "Dependencies not installed, skipping GPU tests"'
    test_slow: 'python -c "import torch" && pytest -v -m slow || echo "Dependencies not installed, skipping slow tests"'
    test_all: 'python -c "import torch" && pytest -v || echo "Dependencies not installed, skipping all tests"'
    coverage: 'python -c "import torch" && pytest --cov=src/tritter --cov-report=json --cov-report=html -m "not gpu" || echo "Dependencies not installed, skipping coverage"'
    coverage_full: "pytest --cov=src/tritter --cov-report=json --cov-report=html"
    build: "python -m build"
    import_check: 'python -c "from tritter import *; print(\"OK\")"'

# Custom Checks for Tritter
custom_checks:
  # Development standards validation
  standards_check:
    command: "python devtools/validate.py"
    feature: skip
    development: warn
    release: error
    production: error

  # Import validation (ensure __all__ matches imports)
  import_validation:
    command: "python devtools/import_validator.py"
    feature: warn
    development: warn
    release: error
    production: error

  # Documentation sync (ADRs, specs, etc.)
  doc_sync:
    command: "python devtools/doc_sync_validator.py"
    feature: skip
    development: warn
    release: warn
    production: error

  # Security: Check for hardcoded secrets, vulnerabilities
  # CRITICAL: Uses wrapper script to distinguish "not installed" from "secrets found"
  security_scan:
    command: 'bash .github/scripts/security-scan-wrapper.sh'
    feature: warn
    development: error
    release: error
    production: error

  # BitNet quantization validation (ensure packed/unpacked round-trip)
  quantization_check:
    command: 'python -c "import torch" && pytest tests/unit/test_quantization.py -v || echo "Dependencies not installed, skipping quantization check"'
    feature: warn
    development: warn
    release: error
    production: error

  # Memory estimation accuracy check
  memory_validation:
    command: 'python -c "import torch" && pytest tests/unit/test_memory_estimation.py -v || echo "Dependencies not installed, skipping memory validation"'
    feature: warn
    development: warn
    release: error
    production: error

  # Bandit static security analysis (parity with remote security job)
  bandit_scan:
    command: 'python -m bandit -r src/tritter -ll -q || echo "Bandit not installed, skipping (pip install bandit)"'
    feature: skip
    development: warn
    release: error
    production: error

  # Build validation (ensure package builds cleanly)
  build_check:
    command: 'python -m build --sdist --no-isolation 2>&1 || echo "Build tools not installed, skipping (pip install build)"'
    feature: skip
    development: warn
    release: error
    production: error

# Output Options
output:
  format: github_actions  # github_actions | gitlab_ci | jenkins | console
  verbose: true
  emoji: true

# Tritter-specific settings
tritter:
  # Hardware profiles to test against
  test_profiles:
    - "RTX_5080_16GB"
    - "RTX_3090_TI_24GB"

  # Model sizes to validate
  model_sizes:
    - "1B"
    - "3B"
    - "7B"

  # Critical architecture validations
  critical_checks:
    - "squared_relu_activation"      # Not SiLU/GELU
    - "qk_norm_enabled"              # Query-key normalization
    - "post_ffn_layernorm"           # Chameleon-style
    - "flash_attention_is_causal"    # Use is_causal=True
    - "symmetric_encode_decode"      # Round-trip preservation
    - "vocab_size_minimum"           # >= 264
